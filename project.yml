name: Macaroni
options:
  bundleIdPrefix: com.macaroni
  deploymentTarget:
    macOS: "14.0"
  createIntermediateGroups: true
  groupSortPosition: top

settings:
  base:
    MARKETING_VERSION: "1.0"
    CURRENT_PROJECT_VERSION: "1"
    SWIFT_VERSION: "5.9"
    MACOSX_DEPLOYMENT_TARGET: "14.0"
    DEVELOPMENT_TEAM: "43QM98RMK6"

packages:
  KeyboardShortcuts:
    url: https://github.com/sindresorhus/KeyboardShortcuts
    from: "2.0.0"
  SimplyCoreAudio:
    url: https://github.com/rnine/SimplyCoreAudio
    from: "4.0.0"
  Solar:
    url: https://github.com/ceeK/Solar
    from: "3.0.0"
  LaunchAtLogin:
    url: https://github.com/sindresorhus/LaunchAtLogin-Modern
    from: "1.0.0"

targets:
  Macaroni:
    type: application
    platform: macOS
    sources:
      - path: Macaroni
        excludes:
          - "**/*.xcassets"
      - path: Resources/Assets.xcassets
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.macaroni.app
        INFOPLIST_FILE: Macaroni/App/Info.plist
        CODE_SIGN_STYLE: Automatic
        ENABLE_HARDENED_RUNTIME: YES
        CODE_SIGN_ENTITLEMENTS: Macaroni/Macaroni.entitlements
        FRAMEWORK_SEARCH_PATHS:
          - "$(inherited)"
          - "/System/Library/PrivateFrameworks"
        OTHER_LDFLAGS:
          - "-weak_framework"
          - "IOMobileFramebuffer"
          - "-weak_framework"
          - "CoreDisplay"
          - "-weak_framework"
          - "DisplayServices"
    dependencies:
      - package: KeyboardShortcuts
      - package: SimplyCoreAudio
      - package: Solar
      - package: LaunchAtLogin
      # System extensions - uncomment when SIP is disabled for testing
      # - target: MacaroniCameraExtension
      #   embed: true
      #   codeSign: true
      # - target: MacaroniAudioExtension
      #   embed: true
      #   codeSign: true
    entitlements:
      path: Macaroni/Macaroni.entitlements
      properties:
        com.apple.security.app-sandbox: false
        com.apple.security.device.camera: true
        com.apple.security.personal-information.location: true
        # Uncomment when SIP is disabled
        # com.apple.developer.system-extension.install: true

  MacaroniCameraExtension:
    type: system-extension
    platform: macOS
    sources:
      - path: MacaroniCameraExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.macaroni.app.camera-extension
        INFOPLIST_FILE: MacaroniCameraExtension/Info.plist
        CODE_SIGN_STYLE: Automatic
        ENABLE_HARDENED_RUNTIME: YES
        SKIP_INSTALL: YES

  MacaroniAudioExtension:
    type: driver-extension
    platform: macOS
    sources:
      - path: MacaroniAudioExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.macaroni.app.audio-extension
        PRODUCT_NAME: MacaroniAudioExtension
        INFOPLIST_FILE: MacaroniAudioExtension/Info.plist
        CODE_SIGN_STYLE: Automatic
        DEVELOPMENT_TEAM: "43QM98RMK6"
        CODE_SIGN_ENTITLEMENTS: MacaroniAudioExtension/MacaroniAudioExtension.entitlements
        ENABLE_HARDENED_RUNTIME: YES
        SKIP_INSTALL: YES
        ARCHS: "$(ARCHS_STANDARD)"
        SDKROOT: driverkit
        DRIVERKIT_DEPLOYMENT_TARGET: "23.0"
        CLANG_CXX_LANGUAGE_STANDARD: "c++20"
        OTHER_LDFLAGS:
          - "-framework"
          - "AudioDriverKit"
          - "-framework"
          - "DriverKit"

  MacaroniFanHelper:
    type: tool
    platform: macOS
    sources:
      - path: MacaroniFanHelper
        excludes:
          - "*.plist"
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.macaroni.fanhelper
        PRODUCT_NAME: com.macaroni.fanhelper
        INFOPLIST_FILE: MacaroniFanHelper/Info.plist
        CODE_SIGN_STYLE: Automatic
        SKIP_INSTALL: NO
        INSTALL_PATH: /Library/PrivilegedHelperTools

schemes:
  Macaroni:
    build:
      targets:
        Macaroni: all
        # Uncomment when SIP is disabled
        # MacaroniCameraExtension: all
        # MacaroniAudioExtension: all
    run:
      config: Debug
    test:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
